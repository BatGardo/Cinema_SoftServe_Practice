@{
    var movie = ViewBag.Movie;
    var screenings = ViewBag.Screenings as List<Cinema_Project.Models.Screening>;
    var halls = new List<(int HallNumber, string HallName, string HallClass)>
    {
        (1, "Red", "hall-red"),
        (2, "Green", "hall-green"),
        (3, "Blue", "hall-blue")
    };
}

<link rel="stylesheet" href="~/css/header-style.css">
<link rel="stylesheet" href="~/css/booking-style.css">
<link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css" />

<div class="container booking-container">
    <div class="screen-container">
        <div class="screen-caption">ЕКРАН</div>
        <div class="screen-img"><img src="~/img/screen.png"></div>
        <div class="seat-container">
            @for (int i = 0; i < 10; i++)
            {
                <div class="seat-row">
                    @for (int j = 0; j < 15; j++)
                    {
                        <div class="seat"></div>
                    }
                </div>
            }
        </div>
    </div>
    <div class="film-book-container">
        <div class="film-info-container">
            <li class="slider-item movie" id="slider-item"
                style="background-image: url('@Url.Content("~/img_posters/" + movie.Title.Replace(":","") + "/" + movie.Title.Replace(":","") + "_SP.jpg")');"></li>
            <div class="film-info">
                <div class="film-info-name">@movie.Title</div> <!-- Назва фільму -->
                <div class="film-data"><span>@($"{movie.Duration / 60}г {movie.Duration % 60}хв")</span> | <span class="film-info-rating">@movie.Rating</span></div>
                <div class="film-trailer-button activate-modal" data-title="@movie.Title">
                    <p>Трейлер</p>
                </div>
            </div>
        </div>
        <div class="line"></div>
        <div class="film-params-container">
            <div class="params-row">
                <div class="row-name">ДАТА</div>
                <div class="row-buttons">
                    @foreach (var screening in screenings.GroupBy(s => s.ScreeningDate.Date).Select(g => g.First()))
                    {
                        <div class="row-button date" data-date="@screening.ScreeningDate.ToString("yyyy-MM-dd")">@screening.ScreeningDate.ToString("dd.MM")</div>
                    }
                </div>
            </div>
            <div class="params-row">
                <div class="params-row">
                    <div class="row-name">ЧАС</div>
                </div>
                <div class="row-buttons">
                    @foreach (var screening in screenings)
                    {
                        <div class="row-button time" data-time="@screening.ScreeningDate.ToString("HH:mm")" data-price="@screening.Price">@screening.ScreeningDate.ToString("HH:mm")</div>
                    }
                </div>
            </div>
            <div class="params-row">
                <div class="params-row">
                    <div class="row-name">ЗАЛ</div>
                </div>
                <div class="row-buttons">
                    @foreach (var hall in halls)
                    {
                        <div class="row-button @hall.HallClass" data-hall="@hall.HallNumber">@hall.HallName</div>
                    }
                </div>
            </div>
        </div>
        <div class="single-seat-price">Ціна місця: @screenings.First().Price ₴</div> <!-- Ціна 1 місця-->
        <div class="line"></div>

        <div class="booked-seats" id="booked-seats"></div>
        <div class="total-price">Всього: 0₴</div> <!-- Загальна ціна -->

        <input type="submit" value="BUY" class="buy-button">
        <button class="buy-button" onclick="initializeTickets()">Придбати квиток</button>
    </div>
</div>

<div id="myModal" class="modal">
    <span id="btn_watch_close" class="close">&times;</span>
    <div id="videoContainer" class="video-container">
        <iframe id="videoPlayer" width="100%" height="100%" src="" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="text-block container">
        <div class="modal-info-container d-flex">
            <div class="modal-film-info">
                <div class="film-name side-elem" id="modalTitle"></div>
                <div class="film-elem side-elem"><b>Жанр: </b></div>
                <div class="film-elem side-elem"><b>Дата виходу: </b></div>
                <div class="film-elem side-elem"><b>Тривалість: </b></div>
                <div class="film-elem side-elem"><b>У головних ролях: </b></div>
                <div class="film-elem side-elem"><b>Опис: </b></div>
            </div>
            <div class="modal-film-side">
                <div class="film-rating"></div>
                <div class="film-elem">
                    <img id="modalImageTag" src="" alt="Alternate Text" />
                </div>

                <div class="btn-border">
                    <button class="film-buy-tickets"><a class="a-buy-tickets" asp-area="" asp-controller="Booking" asp-action="BookingView">Придбати квиток</a></button>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="ticketForm">
    <div>
        <label for="Price">Price</label>
        <input type="text" id="Price" name="Price" />
    </div>
    <div>
        <label for="Showtime">Showtime</label>
        <input type="datetime-local" id="Showtime" name="Showtime" />
    </div>
    <div>
        <label for="HallNumber">Hall Number</label>
        <input type="text" id="HallNumber" name="HallNumber" />
    </div>
    <div>
        <label for="RowNumber">Row Number</label>
        <input type="text" id="RowNumber" name="RowNumber" />
    </div>
    <div>
        <label for="SeatNumber">Seat Number</label>
        <input type="text" id="SeatNumber" name="SeatNumber" />
    </div>
    <div>
        <label for="MovieId">Movie ID</label>
        <input type="text" id="MovieId" name="MovieId" />
    </div>
    <div>
        <label for="UserId">User ID</label>
        <input type="text" id="UserId" name="UserId" />
    </div>
    <button type="button" onclick="createTicket()">Create Ticket</button>
</form>

<script>
    async function createTicket() {
        const form = document.getElementById('ticketForm');
        const formData = new FormData(form);

        const localShowtime = formData.get('Showtime');
        const showtime = new Date(localShowtime);
        const utcShowtime = new Date(showtime.getTime() - (showtime.getTimezoneOffset() * 60000)).toISOString();

        const data = {
            Price: parseFloat(formData.get('Price')),
            Showtime: utcShowtime,
            HallNumber: parseInt(formData.get('HallNumber')),
            RowNumber: parseInt(formData.get('RowNumber')),
            SeatNumber: parseInt(formData.get('SeatNumber')),
            MovieId: parseInt(formData.get('MovieId')),
            UserId: formData.get('UserId')
        };

        try {
            const response = await fetch('/api/ticket/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                alert('Success: ' + result.message);
            } else {
                const error = await response.json();
                alert('Error: ' + error.message + ' Details: ' + error.details);
            }
        } catch (error) {
            alert('Error: ' + error);
        }
    }
</script>

<script src="~/js/seach-button.js"></script>
<script src="~/js/trailer-modal.js"></script>
<script src="~/js/seat-numeration.js"></script>
<script src="~/js/seat-calc.js"></script>